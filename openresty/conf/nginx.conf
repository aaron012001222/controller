worker_processes  1;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # 开启日志 (建议开启，方便排错)
    # access_log /dev/stdout;
    # error_log /dev/stderr;

    # 定义 Lua 模块路径
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";

    # Docker DNS (必须保留，用于解析 backend 和 redis 服务名)
    resolver 127.0.0.11 ipv6=off;

    # 定义 Redis 后端 (用于 Lua 连接 Redis)
    upstream redis_backend {
        server redis:6379;
        keepalive 1024;
    }

    server {
        listen 80;
        server_name localhost;

        # ==========================================
        # 1. 后端 API 接口转发 (新增)
        # ==========================================
        location /api {
            # 'backend' 是 docker-compose.yml 里的服务名
            # 端口 8000 是 main.py 启动的端口
            proxy_pass http://backend:8000;

            # 传递真实 IP 给后端 (重要！否则后端拿不到用户 IP)
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 增加超时时间，防止长时间扫描任务中断
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }

        # ==========================================
        # 2. 前端 Vue 页面 & 流量拦截
        # ==========================================
        location / {
            # [流量控制] 优先执行 Lua 脚本
            # 如果 Lua 判断需要跳转，会直接在 Lua 层结束请求，不会往下走
            access_by_lua_file /usr/local/openresty/nginx/lua/access.lua;
            
            # [管理后台] 如果 Lua 没拦截 (说明是管理员访问或非流量域名)，则显示后台
            # 对应 docker-compose.yml 里的 /usr/share/nginx/html 映射
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            
            # [关键] Vue Router 必须配置 try_files
            # 否则刷新页面会出现 404 错误
            try_files $uri $uri/ /index.html;
        }
    }
}