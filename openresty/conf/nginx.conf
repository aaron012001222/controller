cat << 'EOF' > openresty/conf/nginx.conf
worker_processes  1;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # 【核心修复】删除手动的 lua_package_path，使用系统默认值
    # Docker DNS 和 公网 DNS
    resolver 127.0.0.11 8.8.8.8 ipv6=off;

    # Redis 后端
    upstream redis_backend {
        server redis:6379;
        keepalive 1024;
    }

    # Auto-SSL 共享内存
    lua_shared_dict auto_ssl 1m;
    lua_shared_dict auto_ssl_settings 64k;

    # Auto-SSL 初始化
    init_by_lua_block {
        auto_ssl = (require "resty.auto-ssl").new()
        
        auto_ssl:set("storage_adapter", "resty.auto-ssl.storage_adapter.redis")
        auto_ssl:set("redis_host", "redis")
        auto_ssl:set("redis_port", 6379)

        -- 域名白名单检查
        auto_ssl:set("allow_domain", function(domain)
            local redis = require "resty.redis"
            local red = redis:new()
            red:set_timeout(1000)
            local ok, err = red:connect("redis", 6379)
            if not ok then return false end
            
            local exists, err = red:exists("domain:" .. domain)
            -- 如果 Redis 挂了或查不到，为了安全默认拒绝(false)，或者为了调试暂时允许(true)
            if exists == 1 then return true else return false end
        end)

        auto_ssl:init()
    }

    init_worker_by_lua_block {
        auto_ssl:init_worker()
    }

    # 内部验证服务
    server {
        listen 127.0.0.1:8999;
        client_body_buffer_size 128k;
        client_max_body_size 128k;

        location / {
            content_by_lua_block {
                auto_ssl:hook_server()
            }
        }
    }

    # 主服务
    server {
        listen 80;
        listen 443 ssl;
        server_name _; 

        # 动态证书
        ssl_certificate_by_lua_block {
            auto_ssl:ssl_certificate()
        }

        # 兜底证书
        ssl_certificate     /usr/local/openresty/nginx/certs/server.crt;
        ssl_certificate_key /usr/local/openresty/nginx/certs/server.key;

        location /.well-known/acme-challenge/ {
            content_by_lua_block {
                auto_ssl:challenge_server()
            }
        }

        # 入口占位符
        location = /SECRET_ENTRANCE_PLACEHOLDER {
            add_header Set-Cookie "admin_access=true; Path=/; Max-Age=2592000";
            return 302 /;
        }

        location /api {
            # 使用变量解决启动时 backend 域名解析失败导致崩溃的问题
            set $backend_upstream "backend:8000";
            proxy_pass http://$backend_upstream;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location / {
            access_by_lua_file /usr/local/openresty/nginx/lua/access.lua;
            root   /usr/share/nginx/html;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
    }
}
EOF